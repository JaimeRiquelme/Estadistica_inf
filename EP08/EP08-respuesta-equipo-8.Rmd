---
title: "EP08-Equipo-8"
author: "Jaime Riquelme"
date: "2024-11-18"
output: pdf_document
---

Como habíamos visto a comienzos del semestre, la Encuesta de Caracterización Socioeconómica Nacional (Casen) es realizada por el Ministerio de Desarrollo Social de forma periódica para conocer la situación de los hogares chilenos con relación a aspectos demográficos, de educación, salud, vivienda, trabajo e ingresos. Es la principal fuente de información para estimar la magnitud de la pobreza y la distribución del ingreso en el país.


Cargamos los datos de la encuesta Casen 2017 y los guardamos en un objeto llamado `casen`. Luego, filtramos las columnas de interés para nuestro análisis y guardamos el resultado en un objeto llamado `casen_filtrado`.

```{r}
casen <- read.csv("EP08 Datos CASEN 2017.csv")

#Mostramos los primeros datos
head(casen)
```
Mostramos todas las variables involucradas para conocer el dataset
```{r}
str(casen)
```
# Pregunta 1

Propongan una pregunta de investigación original, que involucre la comparación de una frecuencia de un evento o característica en dos grupos independientes (más abajo se dan unos ejemplos). Fijando una semilla propia, seleccionen una muestra aleatoria de hogares (100 < n < 150) y respondan la pregunta propuesta utilizando una prueba de permutaciones Monte Carlo. Indicación: creen su propio código, específicamente para este problema, no usen directamente el script del apunte.

**Pregunta de investigación**

Como estudiantes de ingenieria civil informatica, se nos pidió trabajar con los datos casen del año 2017, en donde al visualizar los datos, nos dimos cuenta que existen diferentes grupos y tipos de datos, siendo un dato importante el ingreso total de cada persona encuestada, es por eso que nos preguntamos lo siguiente:
¿Existe una diferencia significativa en la proporción de hombres y mujeres que perciben ingresos superiores a $1,000,000 en la Región Metropolitana de Santiago?

Para comenzar a responder esta pregunta, comenzaremos filtrando los datos para obtener las muestras de hombres y mujeres que perciben ingresos superiores a $1,000,000 en la Región Metropolitana de Santiago.


```{r}
library(dplyr)
#Filtramos los datos para obtener las muestras de hombres y mujeres que perciben ingresos superiores a $1,000,000 en la Región Metropolitana de Santiago.

# Primero seleccionamos una muestra aleatoria de la Región Metropolitana
n_muestra <- sample(100:150, 1)
Datos_filtrados_randoms <- casen %>% 
  filter(region == "Región Metropolitana de Santiago") %>%
  sample_n(size = n_muestra, replace = FALSE)

head(Datos_filtrados_randoms)
```


**Formulamos las hipótesis**

H0: La proporción de hombres y mujeres que perciben ingresos superiores a $1,000,000 en la Región Metropolitana de Santiago es la misma. 

(Proporcion_hombres = Proporcion_mujeres)

Ha: La proporción de hombres y mujeres que perciben ingresos superiores a $1,000,000 en la Región Metropolitana de Santiago es distinta.

(Proporcion_hombres != Proporcion_mujeres)

**Se elige la diferencia de proporciones como estadístico de interés ya que permite cuantificar directamente la brecha entre géneros en términos de la proporción que supera el millón de pesos de ingreso. Este estadístico es apropiado para comparar frecuencias entre dos grupos independientes.**


Para responder esta pregunta, utilizaremos un remuestreo de permutaciones Monte Carlo. En este caso, la prueba de permutaciones Monte Carlo se realizará de la siguiente manera:

```{r}
# Creamos las muestras binarias (1 si gana más de 1 millón, 0 si no)
datos_binarios <- Datos_filtrados_randoms %>%
  mutate(sobre_millon = ifelse(ytot > 1000000, 1, 0))

hombres <- datos_binarios %>% 
  filter(sexo == "Hombre") %>% 
  pull(sobre_millon)

mujeres <- datos_binarios %>% 
  filter(sexo == "Mujer") %>% 
  pull(sobre_millon)

# Mostramos estadísticas descriptivas
cat("Resumen de la muestra:\n")
cat("Número de hombres:", length(hombres), "\n")
cat("Número de mujeres:", length(mujeres), "\n")
cat("Proporción de hombres que ganan más de $1,000,000:", mean(hombres), "\n")
cat("Proporción de mujeres que ganan más de $1,000,000:", mean(mujeres), "\n\n")
```

Luego de obtener la muestra de la poblacion aleatoriamente, procedemos a realizar la prueba de permutaciones Monte Carlo utilizando una cantidad de 9999 permutaciones.

```{r}
#Cargamos las librerias necesarias
library(ggpubr)
library(ggplot2)

#Fijamos la semilla
set.seed(1234)

#Definimos la cantidad de permutaciones
B <- 9999

#Función para obtener una permutación
Obt_permutacion = function(i, muestra_1, muestra_2) {
  n_1 = length(muestra_1)
  combinada = c(muestra_1, muestra_2)
  n = length(combinada)
  permutacion = sample(combinada, n, replace = FALSE)
  nueva_1 = permutacion[1:n_1]
  nueva_2 = permutacion[(n_1+1):n]
  return(list(nueva_1, nueva_2))
}


#Función para calcular la diferencia de proporciones
calcular_diferencia = function(muestras) {
  muestra_1 = muestras[[1]]
  muestra_2 = muestras[[2]]
  diferencia = mean(muestra_1) - mean(muestra_2)  # Ahora calcula diferencia de proporciones
  return(diferencia)
}

#Función para calcular el valor p
calcular_valor_p = function(distribucion, valor_observado,
                          repeticiones, alternative) {
  if(alternative == "two.sided") {    
    numerador = sum(abs(distribucion) > abs(valor_observado)) + 1
    denominador = repeticiones + 1
    valor_p = numerador/denominador
  }
  else if(alternative == "greater") {
    numerador = sum(distribucion > valor_observado) + 1
    denominador = repeticiones + 1
    valor_p = numerador/denominador
  }
  else {
    numerador = sum(distribucion < valor_observado) + 1
    denominador = repeticiones + 1
    valor_p = numerador/denominador
  }
  return(valor_p)
}


# Función para hacer la prueba de permutaciones
contrastar_hipotesis_permutaciones = function(muestra_1, muestra_2,
                                            repeticiones, alternative, plot, ...) {
  cat("Prueba de permutaciones para diferencia de proporciones\n\n")
  cat("Hipótesis alternativa: ", alternative, "\n")
  
  #Calcular el valor observado (diferencia de proporciones original)
  observado = mean(muestra_1) - mean(muestra_2)
  cat("Diferencia de proporciones observada: ", round(observado, 4), "\n")
  
  #Generar permutaciones
  permutaciones = lapply(1:repeticiones, Obt_permutacion, muestra_1, muestra_2)
  
  #Generar la distribución
  distribucion = sapply(permutaciones, calcular_diferencia)
  

  #Calcular el valor p
  valor_p = calcular_valor_p(distribucion, observado, repeticiones, alternative)
  
  cat("Valor p: ", valor_p, "\n\n")
}


#Realizamos la prueba de hipótesis
contrastar_hipotesis_permutaciones(hombres, mujeres, repeticiones = B, alternative = "two.sided", plot = TRUE, color = "blue", fill = "blue")

```
**Conclusión**
Luego de realizar la prueba de permutaciones utilizando el método de Monte Carlo, se obtuvo un valor p de 0.4322, lo que nos indica que no existe evidencia suficiente para rechazar la hipótesis nula. Observamos que la proporción de hombres que ganan más de 1,000,000 es 13.11% mientras que en mujeres es 8.8%, pero esta diferencia no es estadísticamente significativa. Por lo tanto, no podemos afirmar que exista una diferencia significativa en la proporción de hombres y mujeres que perciben ingresos superiores a 1,000,000 en la Región Metropolitana de Santiago.
